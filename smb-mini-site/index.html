<!doctype html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SMB Mini Site â€“ EURUSD</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="./data/eurusd_data.js"></script>
  <style>
    :root{--bg:#0b1020;--card:#111831;--line:#1d2751;--muted:#9fb0d0;--txt:#eaf0ff;--up:#2ad08f;--down:#ff6b7d}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1320px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .btns button{background:#1a254d;color:#dbe7ff;border:1px solid #304084;border-radius:10px;padding:7px 12px;cursor:pointer}
    .btns button.active{background:#3553bf}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(170px,1fr));gap:10px;margin:12px 0}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
    .k{font-size:12px;color:var(--muted)} .v{font-size:20px;font-weight:700}
    #chart{height:65vh;min-height:500px;background:var(--card);border:1px solid var(--line);border-radius:12px}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:10px;margin-top:10px}
    .pill{display:inline-block;padding:4px 9px;border-radius:999px;font-size:12px;background:#1a254d}
    .good{color:#58f3b7}.bad{color:#ff8ea0}.warn{color:#ffd77a}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:6px;border-bottom:1px solid var(--line);text-align:right}
    th:first-child,td:first-child{text-align:left}
    @media(max-width:980px){.grid{grid-template-columns:1fr 1fr}.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1 style="margin:6px 0">ðŸ“ˆ SMB Visual â€“ EURUSD</h1>
      <div class="k">Cutoff: <b>21/02/2026</b> | laatste beschikbare candle: <b>20/02/2026</b></div>
    </div>
    <div class="btns">
      <button id="tfD1" class="active">D1 (real data)</button>
      <button id="tfH4">H4 curve (gesimuleerd)</button>
    </div>
  </div>

  <div class="grid" id="stats"></div>
  <div id="chart"></div>

  <div class="row">
    <div class="card">
      <h3>Patroon + Advies</h3>
      <div id="advice" style="line-height:1.6"></div>
      <div class="k" style="margin-top:8px">*H4 is synthetisch opgebouwd uit D1 OHLC (geen broker tick-feed), enkel voor visuele curve/structuur.</div>
    </div>
    <div class="card">
      <h3>Laatste 20 candles (huidige view)</h3>
      <div style="max-height:350px;overflow:auto"><table id="tbl"><thead><tr><th>Datum</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Range</th></tr></thead><tbody></tbody></table></div>
    </div>
  </div>
</div>

<script>
const d1 = window.EURUSD_DATA || [];

function toH4Synthetic(days){
  const out=[];
  for(const d of days){
    const bull = d.close >= d.open;
    const path = bull ? [d.open, d.low, (d.low+d.open)/2, (d.high+d.open)/2, d.high, d.close]
                      : [d.open, d.high, (d.high+d.open)/2, (d.low+d.open)/2, d.low, d.close];
    for(let k=0;k<6;k++){
      const o = path[Math.max(0,k-1)] ?? d.open;
      const c = path[k];
      const hi = Math.max(o,c) + Math.abs(d.high-d.low)*0.06;
      const lo = Math.min(o,c) - Math.abs(d.high-d.low)*0.06;
      out.push({date:`${d.date} H${(k+1)*4}`, open:o, high:Math.min(d.high,hi), low:Math.max(d.low,lo), close:c});
    }
  }
  return out;
}

const h4 = toH4Synthetic(d1);

function pip(v){return (v*10000).toFixed(1)}
function price(v){return v.toFixed(5)}

function swings(data,len=2){
  const highs=[],lows=[];
  for(let i=len;i<data.length-len;i++){
    let sh=true,sl=true;
    for(let j=i-len;j<=i+len;j++){
      if(j===i) continue;
      if(data[i].high<=data[j].high) sh=false;
      if(data[i].low>=data[j].low) sl=false;
    }
    if(sh) highs.push({i,price:data[i].high,date:data[i].date});
    if(sl) lows.push({i,price:data[i].low,date:data[i].date});
  }
  return {highs,lows};
}

function fvg(data){
  const bull=[],bear=[];
  for(let i=2;i<data.length;i++){
    if(data[i].low>data[i-2].high) bull.push({i,from:data[i-2].high,to:data[i].low,type:'bull'});
    if(data[i].high<data[i-2].low) bear.push({i,from:data[i].high,to:data[i-2].low,type:'bear'});
  }
  return {bull,bear};
}

function structure(data){
  const S=swings(data,2); const events=[]; let trend='range';
  for(let i=5;i<data.length;i++){
    const ph=S.highs.filter(x=>x.i<i).slice(-1)[0];
    const pl=S.lows.filter(x=>x.i<i).slice(-1)[0];
    if(ph && data[i].close>ph.price){events.push({i,label:trend==='bear'?'CHoCH â†‘':'BOS â†‘',price:data[i].high}); trend='bull';}
    if(pl && data[i].close<pl.price){events.push({i,label:trend==='bull'?'CHoCH â†“':'BOS â†“',price:data[i].low}); trend='bear';}
  }
  return {S,events,trend};
}

function classify(data,trend,events,S){
  const last = events.slice(-1)[0];
  const recent = events.slice(-4);
  const up = recent.filter(e=>e.label.includes('â†‘')).length;
  const down = recent.filter(e=>e.label.includes('â†“')).length;
  const momentum = (data[data.length-1].close - data[Math.max(0,data.length-6)].close) * 10000;

  // Lokale structuur (laatste swing highs/lows)
  const h2 = S.highs.slice(-2);
  const l2 = S.lows.slice(-2);
  const localLH = h2.length===2 ? h2[1].price < h2[0].price : false;
  const localLL = l2.length===2 ? l2[1].price < l2[0].price : false;
  const localHH = h2.length===2 ? h2[1].price > h2[0].price : false;
  const localHL = l2.length===2 ? l2[1].price > l2[0].price : false;

  let pattern='RANGE / ONBESLIST';
  if(last && last.label.startsWith('CHoCH')) pattern='REVERSAL RISK';
  if((trend==='bull' && up>=down+2) || (trend==='bear' && down>=up+2)) pattern='CONTINUATION';

  // Override met lokale structuur als die duidelijk tegengesteld is
  let regime = trend.toUpperCase();
  let localState = 'MIXED';
  if(localLH && localLL){ localState='BEARISH (LH+LL)'; if(trend==='bull') pattern='PULLBACK / MOGELIJKE REVERSAL'; }
  if(localHH && localHL){ localState='BULLISH (HH+HL)'; if(trend==='bear') pattern='PULLBACK / MOGELIJKE REVERSAL'; }

  let advice='Afblijven tot betere confirmatie.';
  let tone='warn';
  if(localLH && localLL){ advice='Korte termijn bias SHORT/correctie: wacht op pullback naar premium + bearish confirmatie.'; tone='bad'; }
  else if(localHH && localHL){ advice='Korte termijn bias LONG: wacht op retrace naar discount + bullish confirmatie.'; tone='good'; }
  else if(pattern==='CONTINUATION' && trend==='bull' && momentum>0){ advice='Bias LONG: wacht op retrace naar bullish OB/FVG + LTF confirmatie.'; tone='good'; }
  else if(pattern==='CONTINUATION' && trend==='bear' && momentum<0){ advice='Bias SHORT: wacht op pullback naar bearish OB/FVG + LTF confirmatie.'; tone='good'; }
  else if(pattern.includes('REVERSAL')){ advice='Mogelijke omkeer: eerst extra CHoCH/BOS confirmatie op lagere TF voor entry.'; tone='bad'; }

  return {pattern,advice,tone,momentum:momentum.toFixed(1),regime,localState};
}

function render(tf='D1'){
  const data = tf==='D1' ? d1 : h4;
  const O=data.map(d=>d.open),H=data.map(d=>d.high),L=data.map(d=>d.low),C=data.map(d=>d.close),X=data.map(d=>d.date);
  const st=structure(data); const gaps=fvg(data); const cl=classify(data,st.trend,st.events,st.S);

  const avgRange=data.slice(-20).reduce((a,d)=>a+(d.high-d.low),0)/20;
  const stats=[
    ['Timeframe', tf],
    ['Macro trend', cl.regime],
    ['Lokale structuur', cl.localState],
    ['Pattern', cl.pattern],
    ['Momentum (5 bars)', cl.momentum+' pips'],
    ['Laatste close', price(C[C.length-1])],
    ['Gem. range (20)', pip(avgRange)+' pips'],
    ['BOS/CHoCH count', st.events.length],
    ['FVG count', gaps.bull.length+gaps.bear.length]
  ];
  document.getElementById('stats').innerHTML = stats.map(([k,v])=>`<div class='card'><div class='k'>${k}</div><div class='v'>${v}</div></div>`).join('');

  const shapes=[],ann=[];
  const highs=st.S.highs,lows=st.S.lows;
  for(let i=1;i<highs.length;i++) if(Math.abs(highs[i].price-highs[i-1].price)*10000<=8){
    shapes.push({type:'line',x0:highs[i-1].date,x1:highs[i].date,y0:highs[i].price,y1:highs[i].price,line:{color:'#ffd166',dash:'dot',width:2}});
    ann.push({x:highs[i].date,y:highs[i].price,text:'EQH',showarrow:false,font:{size:10,color:'#ffd166'},yshift:10});
  }
  for(let i=1;i<lows.length;i++) if(Math.abs(lows[i].price-lows[i-1].price)*10000<=8){
    shapes.push({type:'line',x0:lows[i-1].date,x1:lows[i].date,y0:lows[i].price,y1:lows[i].price,line:{color:'#a0e7e5',dash:'dot',width:2}});
    ann.push({x:lows[i].date,y:lows[i].price,text:'EQL',showarrow:false,font:{size:10,color:'#a0e7e5'},yshift:-10});
  }

  [...gaps.bull.slice(-3),...gaps.bear.slice(-3)].forEach(z=>{
    shapes.push({type:'rect',x0:data[Math.max(0,z.i-1)].date,x1:data[Math.min(data.length-1,z.i+4)].date,y0:Math.min(z.from,z.to),y1:Math.max(z.from,z.to),fillcolor:z.type==='bull'?'rgba(42,208,143,0.18)':'rgba(255,107,125,0.18)',line:{width:0}})
  });

  st.events.slice(-12).forEach(e=>{
    const j=Math.max(0,e.i-1), d=data[j];
    shapes.push({type:'rect',x0:d.date,x1:data[Math.min(j+2,data.length-1)].date,y0:d.low,y1:d.high,fillcolor:'rgba(103,183,255,0.15)',line:{color:'rgba(103,183,255,0.42)',width:1}});
    ann.push({x:data[e.i].date,y:e.price,text:e.label,showarrow:true,arrowhead:2,ax:0,ay:e.label.includes('â†‘')?-22:22,font:{size:10,color:'#d4e6ff'}});
  });

  const trace={type:'candlestick',x:X,open:O,high:H,low:L,close:C,name:`EURUSD ${tf}`,
    increasing:{line:{color:'#2ad08f'}},decreasing:{line:{color:'#ff6b7d'}}};

  Plotly.newPlot('chart',[trace],{
    paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'#111831',font:{color:'#dbe7ff'},showlegend:false,
    margin:{l:48,r:18,t:16,b:40},xaxis:{rangeslider:{visible:false},gridcolor:'#1f2d5f'},yaxis:{tickformat:'.5f',gridcolor:'#1f2d5f'},
    shapes,annotations:ann
  },{responsive:true});

  const lastEvent = st.events.slice(-1)[0];
  document.getElementById('advice').innerHTML = `
    <div>Patroon: <span class="pill ${cl.tone}"><b>${cl.pattern}</b></span></div>
    <div>Advies: <span class="${cl.tone}"><b>${cl.advice}</b></span></div>
    <div>Macro trend: <b>${cl.regime}</b> | Lokale structuur: <b>${cl.localState}</b></div>
    <div>Laatste structuur-event: <b>${lastEvent?`${lastEvent.label} (${data[lastEvent.i].date})`:'geen'}</b></div>
    <div>Execution flow: Bias â†’ liquidity sweep â†’ CHoCH/MSS (LTF) â†’ retrace naar OB/FVG â†’ entry met strak risico.</div>
    <div style="margin-top:6px" class="k">Dit is educatieve analyse, geen financieel advies.</div>`;

  const tbody=document.querySelector('#tbl tbody'); tbody.innerHTML='';
  data.slice(-20).reverse().forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${d.date}</td><td>${price(d.open)}</td><td>${price(d.high)}</td><td>${price(d.low)}</td><td>${price(d.close)}</td><td>${pip(d.high-d.low)} p</td>`;
    tbody.appendChild(tr);
  });
}

const bD1=document.getElementById('tfD1'), bH4=document.getElementById('tfH4');
bD1.onclick=()=>{bD1.classList.add('active');bH4.classList.remove('active');render('D1')};
bH4.onclick=()=>{bH4.classList.add('active');bD1.classList.remove('active');render('H4')};
render('D1');
</script>
</body>
</html>