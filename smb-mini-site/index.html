<!doctype html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SMB Mini Site â€“ EURUSD</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="./data/forex_data.js"></script>
  <style>
    :root{--bg:#0b1020;--card:#111831;--line:#1d2751;--muted:#9fb0d0;--txt:#eaf0ff;--up:#2ad08f;--down:#ff6b7d}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1320px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .btns button{background:#1a254d;color:#dbe7ff;border:1px solid #304084;border-radius:10px;padding:7px 12px;cursor:pointer}
    .btns button.active{background:#3553bf}
    .tabs{display:flex;gap:8px;margin:10px 0}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(170px,1fr));gap:10px;margin:12px 0}
    .board{display:grid;grid-template-columns:repeat(6,minmax(130px,1fr));gap:8px;margin:10px 0}
    .pairCard{background:#101733;border:1px solid #233065;border-radius:10px;padding:8px;cursor:pointer;transition:.15s transform,.15s border-color;color:#eaf0ff;text-align:left}
    .pairCard:hover{transform:translateY(-1px);border-color:#6f8dff}
    .pairCard.active{outline:1px solid #6f8dff}
    .pairCard .p{font-weight:700;font-size:12px}
    .pairCard .s{font-size:11px;color:#b8cbff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
    .k{font-size:12px;color:var(--muted)} .v{font-size:20px;font-weight:700}
    #chart{height:65vh;min-height:500px;background:var(--card);border:1px solid var(--line);border-radius:12px}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:10px;margin-top:10px}
    .pill{display:inline-block;padding:4px 9px;border-radius:999px;font-size:12px;background:#1a254d}
    .good{color:#58f3b7}.bad{color:#ff8ea0}.warn{color:#ffd77a}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:6px;border-bottom:1px solid var(--line);text-align:right}
    th:first-child,td:first-child{text-align:left}
    .row-win{background:rgba(42,208,143,0.12)} .row-loss{background:rgba(255,107,125,0.12)} .row-be{background:rgba(255,215,122,0.16)}
    .clickable-row{cursor:pointer}
    @media(max-width:980px){.grid{grid-template-columns:1fr 1fr}.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1 style="margin:6px 0">ðŸ“ˆ SMB Visual â€“ FX Pairs</h1>
      <div class="k">Cutoff: <b>21/02/2026</b> | <span id="pairLabel">EURUSD</span></div>
    </div>
    <div class="btns">
      <select id="pairSelect" style="background:#1a254d;color:#dbe7ff;border:1px solid #304084;border-radius:10px;padding:7px 10px;margin-right:6px"></select>
      <button id="tfD1" class="active">D1 (real data)</button>
      <button id="tfH4">H4 curve (gesimuleerd)</button>
      <button id="strictBtn">Strict PDF mode: OFF</button>
      <button id="rrBtn">RR model: 1:2</button>
    </div>
  </div>

  <div class="tabs btns">
    <button id="tabAnalysis" class="active">SMB Analyse</button>
    <button id="tabBacktest">Backtesting</button>
  </div>

  <div id="analysisView">
  <div class="card">
    <h3 style="margin:4px 0 8px">FX Dashboard â€“ Trade mogelijk?</h3>
    <div id="pairBoard" class="board"></div>
  </div>

  <div class="grid" id="stats"></div>
  <div id="chart"></div>
  <div class="card" style="margin-top:10px">
    <h3 style="margin:4px 0 8px">Daily Trend Focus (met Supply/Demand + TP)</h3>
    <div id="trendChart" style="height:50vh;min-height:360px"></div>
  </div>

  <div class="row">
    <div class="card">
      <h3>Patroon + Advies</h3>
      <div id="advice" style="line-height:1.6"></div>
      <div class="k" style="margin-top:8px">*H4 is synthetisch opgebouwd uit D1 OHLC (geen broker tick-feed), enkel voor visuele curve/structuur.</div>
    </div>
    <div class="card">
      <h3>Laatste 20 candles (huidige view)</h3>
      <div style="max-height:350px;overflow:auto"><table id="tbl"><thead><tr><th>Datum</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Range</th></tr></thead><tbody></tbody></table></div>
    </div>
  </div>
  </div>

  <div id="backtestView" class="hidden">
    <div class="card">
      <h3 style="margin:4px 0 8px">Backtest Dashboard (Wins / Losses / Break-even)</h3>
      <div class="btns" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <select id="btYear" style="background:#1a254d;color:#dbe7ff;border:1px solid #304084;border-radius:10px;padding:7px 10px"><option>2024</option><option>2025</option><option selected>2026</option></select>
        <label style="display:flex;align-items:center;gap:6px">Startkapitaal â‚¬ <input id="btCapital" type="number" value="10000" min="100" step="100" style="width:110px;background:#1a254d;color:#dbe7ff;border:1px solid #304084;border-radius:8px;padding:5px 8px"></label>
        <label style="display:flex;align-items:center;gap:6px">Risico % <input id="btRisk" type="number" value="1" min="0.1" max="5" step="0.1" style="width:70px;background:#1a254d;color:#dbe7ff;border:1px solid #304084;border-radius:8px;padding:5px 8px"></label>
        <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="btTrailing" /> Trailing ON</label>
        <button id="btRun">Run backtest</button>
        <span id="btStatus" class="k"></span>
      </div>
      <div id="btBoard" class="board"></div>
    </div>
    <div class="row">
      <div class="card">
        <h3>Detail voor geselecteerd pair</h3>
        <div id="btDetail"></div>
      </div>
      <div class="card">
        <h3>Laatste trades</h3>
        <div style="max-height:350px;overflow:auto"><table id="btTable"><thead><tr><th>Date</th><th>Side</th><th>Entry</th><th>SL</th><th>TP</th><th>Result</th><th>PnL â‚¬</th><th>Equity â‚¬</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>
    <div class="card" style="margin-top:10px">
      <h3>Trade detail (klik een rij)</h3>
      <div id="btTradeDetail" class="k">Nog geen trade geselecteerd.</div>
    </div>
  </div>
</div>

<script>
const ALL = window.FOREX_DATA || {};
let currentPair = 'EURUSD';
let d1 = ALL[currentPair] || [];

function toH4Synthetic(days){
  const out=[];
  for(const d of days){
    const bull = d.close >= d.open;
    const path = bull ? [d.open, d.low, (d.low+d.open)/2, (d.high+d.open)/2, d.high, d.close]
                      : [d.open, d.high, (d.high+d.open)/2, (d.low+d.open)/2, d.low, d.close];
    for(let k=0;k<6;k++){
      const o = path[Math.max(0,k-1)] ?? d.open;
      const c = path[k];
      const hi = Math.max(o,c) + Math.abs(d.high-d.low)*0.06;
      const lo = Math.min(o,c) - Math.abs(d.high-d.low)*0.06;
      out.push({date:`${d.date} H${(k+1)*4}`, open:o, high:Math.min(d.high,hi), low:Math.max(d.low,lo), close:c});
    }
  }
  return out;
}

// H4 wordt per geselecteerde pair dynamisch opgebouwd

function pip(v){return (v*10000).toFixed(1)}
function price(v){return v.toFixed(5)}

function swings(data,len=2){
  const highs=[],lows=[];
  for(let i=len;i<data.length-len;i++){
    let sh=true,sl=true;
    for(let j=i-len;j<=i+len;j++){
      if(j===i) continue;
      if(data[i].high<=data[j].high) sh=false;
      if(data[i].low>=data[j].low) sl=false;
    }
    if(sh) highs.push({i,price:data[i].high,date:data[i].date});
    if(sl) lows.push({i,price:data[i].low,date:data[i].date});
  }
  return {highs,lows};
}

function fvg(data){
  const bull=[],bear=[];
  for(let i=2;i<data.length;i++){
    if(data[i].low>data[i-2].high) bull.push({i,from:data[i-2].high,to:data[i].low,type:'bull'});
    if(data[i].high<data[i-2].low) bear.push({i,from:data[i].high,to:data[i-2].low,type:'bear'});
  }
  return {bull,bear};
}

function structure(data){
  const S=swings(data,2); const events=[]; let trend='range';
  for(let i=5;i<data.length;i++){
    const ph=S.highs.filter(x=>x.i<i).slice(-1)[0];
    const pl=S.lows.filter(x=>x.i<i).slice(-1)[0];
    if(ph && data[i].close>ph.price){events.push({i,label:trend==='bear'?'CHoCH â†‘':'BOS â†‘',price:data[i].high}); trend='bull';}
    if(pl && data[i].close<pl.price){events.push({i,label:trend==='bull'?'CHoCH â†“':'BOS â†“',price:data[i].low}); trend='bear';}
  }
  return {S,events,trend};
}

function latestWeekContext(d1data){
  const wk = d1data.slice(-5);
  const wHigh = Math.max(...wk.map(x=>x.high));
  const wLow = Math.min(...wk.map(x=>x.low));
  const close = wk[wk.length-1].close;
  const range = wHigh-wLow;
  const closePct = ((close-wLow)/range)*100;
  const fib618 = wLow + 0.618*range;
  return {wk,wHigh,wLow,close,range,closePct,fib618};
}

function classify(data,trend,events,S,isH4=false,strictMode=false,baseDaily=d1){
  const last = events.slice(-1)[0];
  const recent = events.slice(-4);
  const up = recent.filter(e=>e.label.includes('â†‘')).length;
  const down = recent.filter(e=>e.label.includes('â†“')).length;
  const momentum = (data[data.length-1].close - data[Math.max(0,data.length-6)].close) * 10000;

  const h2 = S.highs.slice(-2), l2=S.lows.slice(-2);
  const localLH = h2.length===2 ? h2[1].price < h2[0].price : false;
  const localLL = l2.length===2 ? l2[1].price < l2[0].price : false;
  const localHH = h2.length===2 ? h2[1].price > h2[0].price : false;
  const localHL = l2.length===2 ? l2[1].price > l2[0].price : false;

  const W = latestWeekContext(baseDaily);
  const nearWeeklyLow = Math.abs(W.close-W.wLow)*10000 <= 50;
  const inLowerThird = W.closePct <= 33.33;

  let pattern='RANGE / ONBESLIST';
  let regime = trend.toUpperCase();
  let localState = 'MIXED';

  if(localLH && localLL){ localState='BEARISH (LH+LL)'; pattern='CONTINUATION (bearish pullback model)'; }
  else if(localHH && localHL){ localState='BULLISH (HH+HL)'; pattern='CONTINUATION (bullish pullback model)'; }
  else if(last && last.label.startsWith('CHoCH')){ pattern='REVERSAL RISK'; }

  if((trend==='bull' && down>=up+2) || (trend==='bear' && up>=down+2)) pattern='PULLBACK / MOGELIJKE REVERSAL';

  let advice='Afblijven tot betere confirmatie.';
  let tone='warn';

  // PDF-regels: niet verkopen op weekly low, niet kopen op weekly high
  if(localLH && localLL && inLowerThird){
    if(nearWeeklyLow){
      advice=`TFD: GEEN chase short op weekly low. Wacht pullback richting ${price(W.fib618)}-${price(W.wHigh)} (Fib 61.8-100) + bearish confirmatie.`;
      tone='warn';
    }else{
      advice=`TFD sell pullback: focus op reverse-zone ${price(W.fib618)}-${price(W.wHigh)} (Fib 61.8-100), pas na pattern confirmatie.`;
      tone='good';
    }
  } else if(localHH && localHL && W.closePct>=66.66){
    advice=`TFD: GEEN chase long op weekly high. Wacht diepere pullback + bullish pattern confirmatie.`;
    tone='warn';
  } else if(pattern.includes('REVERSAL')){
    advice='Mogelijke omkeer: eerst M/W of H&S/iH&S bevestiging, daarna pas uitvoering op LTF.';
    tone='bad';
  }

  // Strict PDF-mode: toon enkel "actieve" setups als alle kernregels matchen
  let strictPass = true;
  if(strictMode){
    const bearishStrict = localLH && localLL && !nearWeeklyLow;
    const bullishStrict = localHH && localHL && W.closePct < 66.66;
    strictPass = bearishStrict || bullishStrict;
    if(!strictPass){
      pattern = 'NO TRADE (STRICT PDF)';
      advice = 'Geen setup: wacht tot prijs in reverse-zone komt + pattern confirmatie (M/W/H&S/iH&S).';
      tone = 'warn';
    }
  }

  return {pattern,advice,tone,momentum:momentum.toFixed(1),regime,localState,week:W,nearWeeklyLow,inLowerThird,strictPass};
}

function fibZonesFromSwings(data, S){
  const sh = S.highs.slice(-2);
  const sl = S.lows.slice(-2);
  // default fallback
  let high = Math.max(...data.slice(-40).map(d=>d.high));
  let low = Math.min(...data.slice(-40).map(d=>d.low));

  if(sh.length && sl.length){
    const lh = sh[sh.length-1], ll = sl[sl.length-1];
    high = lh.price; low = ll.price;
    if(lh.i < ll.i){ // laatste impuls omlaag
      high = lh.price; low = ll.price;
    } else { // laatste impuls omhoog
      high = lh.price; low = ll.price;
    }
  }

  const range = Math.max(high-low, 0.0001);
  const supplyLow = low + 0.618*range, supplyHigh = high;      // retrace 61.8-100 van down-leg
  const demandLow = low, demandHigh = high - 0.618*range;      // retrace 61.8-100 van up-leg
  return {high,low,range,supplyLow,supplyHigh,demandLow,demandHigh};
}

function countZoneReactions(data, zLow, zHigh, side='sell'){
  // "reactie": wick in zone + close weg van zone-richting
  let touches=0, reactions=0;
  const start=Math.max(2, data.length-140), end=Math.max(start+1, data.length-5);
  for(let i=start;i<end;i++){
    const d=data[i];
    const inZone = d.high>=zLow && d.low<=zHigh;
    if(!inZone) continue;
    touches++;
    if(side==='sell'){
      const reject = d.high>=zLow && d.close<d.open && data[i+1] && data[i+1].close<d.close;
      if(reject) reactions++;
    } else {
      const reject = d.low<=zHigh && d.close>d.open && data[i+1] && data[i+1].close>d.close;
      if(reject) reactions++;
    }
  }
  return {touches,reactions};
}

function detectBearishWStrict(data, S){
  // Strikte 5-punts structuur: H1-L1-H2-L2-H3 met LH op highs en LL op lows + neckline break
  const piv=[...S.highs.map(p=>({...p,t:'H'})), ...S.lows.map(p=>({...p,t:'L'}))].sort((a,b)=>a.i-b.i);
  if(piv.length < 5) return {ok:false, points:[], neckline:null};

  const seq=[];
  for(let i=0;i<piv.length;i++){
    if(seq.length===0 || seq[seq.length-1].t!==piv[i].t) seq.push(piv[i]);
    else {
      // bij gelijke type: voor H neem hogere, voor L neem lagere (scherper pivot)
      if(piv[i].t==='H' && piv[i].price>seq[seq.length-1].price) seq[seq.length-1]=piv[i];
      if(piv[i].t==='L' && piv[i].price<seq[seq.length-1].price) seq[seq.length-1]=piv[i];
    }
  }

  for(let i=Math.max(0,seq.length-12); i<=seq.length-5; i++){
    const p1=seq[i], p2=seq[i+1], p3=seq[i+2], p4=seq[i+3], p5=seq[i+4];
    if(!(p1.t==='H'&&p2.t==='L'&&p3.t==='H'&&p4.t==='L'&&p5.t==='H')) continue;

    const lh = p3.price < p1.price && p5.price < p3.price;
    const ll = p4.price < p2.price;
    const nearEqualL = Math.abs(p4.price-p2.price)*10000 <= 35; // W-vorm maar bearish variant
    const neckline = Math.min(p2.price,p4.price);
    const broke = data.slice(p5.i+1).some(c=>c.close < neckline);

    if(lh && (ll || nearEqualL) && broke){
      return {ok:true, points:[p1,p2,p3,p4,p5], neckline};
    }
  }
  return {ok:false, points:[], neckline:null};
}

function render(tf='D1', strictMode=false){
  d1 = ALL[currentPair] || [];
  const h4Local = toH4Synthetic(d1);
  const data = tf==='D1' ? d1 : h4Local;
  const O=data.map(d=>d.open),H=data.map(d=>d.high),L=data.map(d=>d.low),C=data.map(d=>d.close),X=data.map(d=>d.date);
  const mainBars = tf==='D1' ? 75 : 140;
  const mainStart = Math.max(0, data.length-mainBars);
  const st=structure(data); const gaps=fvg(data); const cl=classify(data,st.trend,st.events,st.S,tf==='H4',strictMode,d1);

  document.getElementById('pairLabel').textContent = `${currentPair} (laatste candle: ${d1[d1.length-1]?.date || '-'})`;
  const avgRange=data.slice(-20).reduce((a,d)=>a+(d.high-d.low),0)/20;
  const stats=[
    ['Timeframe', tf],
    ['Macro trend', cl.regime],
    ['Lokale structuur', cl.localState],
    ['Pattern', cl.pattern],
    ['Strict PDF', strictMode ? (cl.strictPass ? 'PASS' : 'BLOCK') : 'OFF'],
    ['Weekly close in range', cl.week.closePct.toFixed(2)+'%'],
    ['Weekly H/L', `${price(cl.week.wHigh)} / ${price(cl.week.wLow)}`],
    ['Fib reverse zone', `${price(cl.week.fib618)} - ${price(cl.week.wHigh)}`],
    ['Laatste close', price(C[C.length-1])],
    ['Gem. range (20)', pip(avgRange)+' pips'],
    ['BOS/CHoCH count', st.events.length],
    ['FVG count', gaps.bull.length+gaps.bear.length]
  ];
  document.getElementById('stats').innerHTML = stats.map(([k,v])=>`<div class='card'><div class='k'>${k}</div><div class='v'>${v}</div></div>`).join('');

  const shapes=[],ann=[];
  const highs=st.S.highs,lows=st.S.lows;
  for(let i=1;i<highs.length;i++) if(Math.abs(highs[i].price-highs[i-1].price)*10000<=8){
    shapes.push({type:'line',x0:highs[i-1].date,x1:highs[i].date,y0:highs[i].price,y1:highs[i].price,line:{color:'#ffd166',dash:'dot',width:2}});
    ann.push({x:highs[i].date,y:highs[i].price,text:'EQH',showarrow:false,font:{size:10,color:'#ffd166'},yshift:10});
  }
  for(let i=1;i<lows.length;i++) if(Math.abs(lows[i].price-lows[i-1].price)*10000<=8){
    shapes.push({type:'line',x0:lows[i-1].date,x1:lows[i].date,y0:lows[i].price,y1:lows[i].price,line:{color:'#a0e7e5',dash:'dot',width:2}});
    ann.push({x:lows[i].date,y:lows[i].price,text:'EQL',showarrow:false,font:{size:10,color:'#a0e7e5'},yshift:-10});
  }

  [...gaps.bull.slice(-3),...gaps.bear.slice(-3)].forEach(z=>{
    shapes.push({type:'rect',x0:data[Math.max(0,z.i-1)].date,x1:data[Math.min(data.length-1,z.i+4)].date,y0:Math.min(z.from,z.to),y1:Math.max(z.from,z.to),fillcolor:z.type==='bull'?'rgba(42,208,143,0.18)':'rgba(255,107,125,0.18)',line:{width:0}})
  });

  st.events.slice(-12).forEach(e=>{
    const j=Math.max(0,e.i-1), d=data[j];
    shapes.push({type:'rect',x0:d.date,x1:data[Math.min(j+2,data.length-1)].date,y0:d.low,y1:d.high,fillcolor:'rgba(103,183,255,0.15)',line:{color:'rgba(103,183,255,0.42)',width:1}});
    ann.push({x:data[e.i].date,y:e.price,text:e.label,showarrow:true,arrowhead:2,ax:0,ay:e.label.includes('â†‘')?-22:22,font:{size:10,color:'#d4e6ff'}});
  });

  // TFD referentielijnen (weekly high/low + Fib 61.8)
  const x0 = X[Math.max(0, X.length-80)], x1 = X[X.length-1];
  shapes.push({type:'line',x0,x1,y0:cl.week.wHigh,y1:cl.week.wHigh,line:{color:'#ffcf6b',width:1,dash:'dash'}});
  shapes.push({type:'line',x0,x1,y0:cl.week.wLow,y1:cl.week.wLow,line:{color:'#7ce2ff',width:1,dash:'dash'}});
  shapes.push({type:'line',x0,x1,y0:cl.week.fib618,y1:cl.week.fib618,line:{color:'#c3a6ff',width:1,dash:'dot'}});
  ann.push({x:x1,y:cl.week.wHigh,text:'Weekly High',showarrow:false,font:{size:10,color:'#ffcf6b'},xanchor:'right',xshift:-6});
  ann.push({x:x1,y:cl.week.wLow,text:'Weekly Low',showarrow:false,font:{size:10,color:'#7ce2ff'},xanchor:'right',xshift:-6});
  ann.push({x:x1,y:cl.week.fib618,text:'Fib 61.8',showarrow:false,font:{size:10,color:'#c3a6ff'},xanchor:'right',xshift:-6});

  const trace={type:'candlestick',x:X,open:O,high:H,low:L,close:C,name:`${currentPair} ${tf}`,
    increasing:{line:{color:'#2ad08f'}},decreasing:{line:{color:'#ff6b7d'}}};

  Plotly.newPlot('chart',[trace],{
    paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'#111831',font:{color:'#dbe7ff'},showlegend:false,
    margin:{l:48,r:90,t:16,b:40},xaxis:{rangeslider:{visible:false},gridcolor:'#1f2d5f',range:[X[mainStart], X[X.length-1]]},yaxis:{tickformat:'.5f',gridcolor:'#1f2d5f'},
    shapes,annotations:ann
  },{responsive:true});

  const lastEvent = st.events.slice(-1)[0];
  document.getElementById('advice').innerHTML = `
    <div>Patroon: <span class="pill ${cl.tone}"><b>${cl.pattern}</b></span></div>
    <div>Strict PDF mode: <b>${strictMode ? (cl.strictPass ? 'AAN (PASS)' : 'AAN (BLOCK)') : 'UIT'}</b></div>
    <div>Advies: <span class="${cl.tone}"><b>${cl.advice}</b></span></div>
    <div>Macro trend: <b>${cl.regime}</b> | Lokale structuur: <b>${cl.localState}</b></div>
    <div>Weekly context (TFD): H=<b>${price(cl.week.wHigh)}</b>, L=<b>${price(cl.week.wLow)}</b>, CloseInRange=<b>${cl.week.closePct.toFixed(2)}%</b></div>
    <div>Reverse-zone (Fib 61.8-100): <b>${price(cl.week.fib618)} - ${price(cl.week.wHigh)}</b></div>
    <div>Regelcheck: <b>${cl.nearWeeklyLow ? 'Niet verkopen op weekly low actief' : 'Geen weekly-low blokkade'}</b></div>
    <div>Laatste structuur-event: <b>${lastEvent?`${lastEvent.label} (${data[lastEvent.i].date})`:'geen'}</b></div>
    <div>Execution flow: Bias â†’ liquidity sweep â†’ M/W/H&S/iH&S confirmatie â†’ retrace in zone â†’ entry met strak risico.</div>
    <div>Daily S&D bepaling: Fib 61.8-100 op recente swing + validatie met historische reacties in die zone.</div>
    <div style="margin-top:6px" class="k">Dit is educatieve analyse, geen financieel advies.</div>`;

  const tbody=document.querySelector('#tbl tbody'); tbody.innerHTML='';
  data.slice(-20).reverse().forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${d.date}</td><td>${price(d.open)}</td><td>${price(d.high)}</td><td>${price(d.low)}</td><td>${price(d.close)}</td><td>${pip(d.high-d.low)} p</td>`;
    tbody.appendChild(tr);
  });

  // Extra grafische voorstelling: alleen huidige daily trend + supply/demand + TP
  const dDaily = d1;
  const stD = structure(dDaily);
  const dCl = classify(dDaily, stD.trend, stD.events, stD.S, false, strictMode, dDaily);
  const last = dDaily[dDaily.length-1];
  const zones = fibZonesFromSwings(dDaily, stD.S);
  const xD = dDaily.map(d=>d.date), oD=dDaily.map(d=>d.open), hD=dDaily.map(d=>d.high), lD=dDaily.map(d=>d.low), cD=dDaily.map(d=>d.close);
  const start = Math.max(0, dDaily.length-40);

  let tradeSide = 'none';
  if(dCl.localState.includes('BEARISH')) tradeSide='sell';
  else if(dCl.localState.includes('BULLISH')) tradeSide='buy';

  let entry = last.close;
  // S&D volgens jouw regel: zone tussen Fib 61.8 en 100, bepaald op recente swing
  const supplyZone = {low:zones.supplyLow, high:zones.supplyHigh};
  const demandZone = {low:zones.demandLow, high:zones.demandHigh};

  // SL ruimer buiten zone (buffer + ATR-achtige minimum afstand)
  const zoneBuffer = 0.0015; // 15 pips
  let sl = tradeSide==='sell' ? (supplyZone.high + zoneBuffer) : (demandZone.low - zoneBuffer);
  const risk = Math.max(Math.abs(entry-sl), 0.0020); // min 20 pips risk zodat TP/SL niet op elkaar plakken
  let tp1 = tradeSide==='sell' ? entry - risk*rrMult : entry + risk*rrMult;
  let tp2 = tradeSide==='sell' ? entry - risk*(rrMult+1) : entry + risk*(rrMult+1);

  if(tradeSide==='sell') tp1 = Math.min(tp1, demandZone.high);
  if(tradeSide==='buy') tp1 = Math.max(tp1, supplyZone.low);

  const sellRx = countZoneReactions(dDaily, supplyZone.low, supplyZone.high, 'sell');
  const buyRx = countZoneReactions(dDaily, demandZone.low, demandZone.high, 'buy');

  // Toon slechts 1 actieve zone (zoals gevraagd): supply OF demand op basis van huidige structuur
  const activeZone = tradeSide==='sell'
    ? {name:'Supply', low:supplyZone.low, high:supplyZone.high, rx:sellRx, color:'rgba(255,107,125,0.16)', line:'rgba(255,107,125,0.55)'}
    : tradeSide==='buy'
      ? {name:'Demand', low:demandZone.low, high:demandZone.high, rx:buyRx, color:'rgba(42,208,143,0.16)', line:'rgba(42,208,143,0.55)'}
      : null;

  const tShapes=[];
  if(activeZone){
    tShapes.push({type:'rect',x0:xD[start],x1:xD[xD.length-1],y0:activeZone.low,y1:activeZone.high,fillcolor:activeZone.color,line:{color:activeZone.line,width:1}});
  }
  if(tradeSide!=='none'){
    tShapes.push({type:'line',x0:xD[start],x1:xD[xD.length-1],y0:tp1,y1:tp1,line:{color:'#ffd166',dash:'dash',width:2}});
    tShapes.push({type:'line',x0:xD[start],x1:xD[xD.length-1],y0:tp2,y1:tp2,line:{color:'#f7b500',dash:'dot',width:2}});
  }

  // Strikte bearish-W tekening (5 punten + neckline break)
  const bW = detectBearishWStrict(dDaily, stD.S);
  if(tradeSide==='sell' && bW.ok){
    for(let k=1;k<bW.points.length;k++){
      const a=bW.points[k-1], b=bW.points[k];
      tShapes.push({type:'line',x0:dDaily[a.i].date,x1:dDaily[b.i].date,y0:a.price,y1:b.price,line:{color:'#ff9fb0',width:2}});
    }
    tShapes.push({type:'line',x0:dDaily[bW.points[0].i].date,x1:dDaily[dDaily.length-1].date,y0:bW.neckline,y1:bW.neckline,line:{color:'#ff9fb0',dash:'dot',width:1}});
  }

  const tAnn=[
    {x:xD[xD.length-1],y:entry,text:`Entry ${price(entry)}`,showarrow:false,xanchor:'right',xshift:-6,font:{size:10,color:'#b8cbff'}},
    {x:xD[xD.length-1],y:sl,text:`SL ${price(sl)}`,showarrow:false,xanchor:'right',xshift:-6,font:{size:10,color:'#ff9fb0'}},
    {x:xD[Math.max(start, xD.length-25)],y:hD.slice(-20).reduce((a,b)=>Math.max(a,b),-1e9),text:`Current Daily Trend: ${dCl.localState}`,showarrow:false,font:{size:12,color:'#dbe7ff'}}
  ];
  if(activeZone){
    tAnn.push({x:xD[xD.length-1],y:activeZone.high,text:`${activeZone.name} Fib(61.8-100): ${price(activeZone.low)}-${price(activeZone.high)} | reacts ${activeZone.rx.reactions}/${activeZone.rx.touches}`,showarrow:false,xanchor:'right',xshift:-6,font:{size:10,color:tradeSide==='sell'?'#ffb3bf':'#8df0c9'}});
  }
  if(tradeSide==='sell'){
    tAnn.push({x:xD[xD.length-1],y:hD.slice(-20).reduce((a,b)=>Math.max(a,b),-1e9)-0.0005,text:bW.ok?'Bearish W (strict, neckline break)':'Bearish W strict: niet bevestigd',showarrow:false,xanchor:'right',font:{size:10,color:'#ff9fb0'}});
  }
  if(tradeSide!=='none'){
    tAnn.push({x:xD[xD.length-1],y:tp1,text:`TP1 ${price(tp1)} (RR ${rrMult.toFixed(0)}R)`,showarrow:false,xanchor:'right',xshift:-6,font:{size:10,color:'#ffd166'}});
    tAnn.push({x:xD[xD.length-1],y:tp2,text:`TP2 ${price(tp2)} (RR ${(rrMult+1).toFixed(0)}R)`,showarrow:false,xanchor:'right',xshift:-6,font:{size:10,color:'#f7b500'}});
  } else {
    tAnn.push({x:xD[xD.length-1],y:last.close,text:'NO TRADE: geen duidelijke HH/HL of LH/LL',showarrow:false,xanchor:'right',xshift:-6,font:{size:10,color:'#ffd166'}});
  }

  Plotly.newPlot('trendChart',[{type:'candlestick',x:xD.slice(start),open:oD.slice(start),high:hD.slice(start),low:lD.slice(start),close:cD.slice(start),
      increasing:{line:{color:'#2ad08f'}},decreasing:{line:{color:'#ff6b7d'}}}],{
    paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'#111831',font:{color:'#dbe7ff'},showlegend:false,
    margin:{l:48,r:95,t:10,b:35},xaxis:{rangeslider:{visible:false},gridcolor:'#1f2d5f',range:[xD[start],xD[xD.length-1]]},yaxis:{tickformat:'.5f',gridcolor:'#1f2d5f'},
    shapes:tShapes,annotations:tAnn
  },{responsive:true});
}

function runBacktestForPair(arr, year='2026', trailing=false, startCapital=10000, riskPct=1){
  const rows = arr.filter(r=>r.date.startsWith(year+'-'));
  const h4 = toH4Synthetic(rows);
  const trades=[];
  let equity = Number(startCapital);

  const warmup = Math.min(70, Math.max(25, Math.floor(rows.length*0.2)));
  for(let i=warmup;i<rows.length-8;i++){
    const slice = rows.slice(Math.max(0,i-70), i+1);
    const st = structure(slice);
    const cl = classify(slice, st.trend, st.events, st.S, false, false, slice);
    let side = cl.localState.includes('BEARISH') ? 'SELL' : cl.localState.includes('BULLISH') ? 'BUY' : null;
    if(!side) side = st.trend==='bear' ? 'SELL' : st.trend==='bull' ? 'BUY' : null;
    if(!side) continue;

    const zones = fibZonesFromSwings(slice, st.S);
    const zone = side==='SELL' ? {low:zones.supplyLow, high:zones.supplyHigh} : {low:zones.demandLow, high:zones.demandHigh};
    const day = rows[i];
    const inZone = day.high>=zone.low && day.low<=zone.high;
    if(!inZone) continue;

    // Strategy toevoeging: uitvoering op H4
    const baseRange = Math.max(0.0001, day.high-day.low);
    const prevAvgRange = slice.slice(-8).reduce((a,b)=>a+(b.high-b.low),0)/Math.max(1,slice.slice(-8).length);
    const impulsive = baseRange > prevAvgRange*1.2;

    const h4Day = h4.filter(c=>c.date.startsWith(day.date));
    if(h4Day.length<4) continue;

    let entry = day.close, trigger='';
    if(impulsive){
      // deceleration: body size neemt af en na 2 H4 closes entry
      let found=false;
      for(let k=2;k<h4Day.length;k++){
        const b0=Math.abs(h4Day[k-2].close-h4Day[k-2].open);
        const b1=Math.abs(h4Day[k-1].close-h4Day[k-1].open);
        if(b1 < b0*0.85){ entry = h4Day[k-1].close; found=true; trigger='Impulsive -> deceleration (2x H4 close)'; break; }
      }
      if(!found) continue;
    } else {
      // Corrective: fib completion -27 op H4 (proxy via extensiecheck)
      const dHigh=Math.max(...h4Day.map(x=>x.high)), dLow=Math.min(...h4Day.map(x=>x.low));
      const r=Math.max(dHigh-dLow,0.0001);
      const ext = side==='SELL' ? (dLow - 0.27*r) : (dHigh + 0.27*r);
      const hit = side==='SELL' ? h4Day.some(x=>x.low<=ext) : h4Day.some(x=>x.high>=ext);
      if(!hit) continue;
      entry = h4Day[h4Day.length-1].close;
      trigger='Corrective -> Fib completion -27 (H4)';
    }

    const sl = side==='SELL' ? zone.high + 0.0015 : zone.low - 0.0015;
    const risk = Math.max(Math.abs(entry-sl), 0.0020);
    const tp = side==='SELL' ? entry - 2*risk : entry + 2*risk;

    let result='LOSS', slLive=sl, exitPrice=null;
    for(let j=i+1;j<Math.min(rows.length,i+12);j++){
      const b=rows[j];
      const up = ((b.high-entry)/entry)*100;
      const dn = ((entry-b.low)/entry)*100;
      if(trailing){
        if(side==='BUY'){
          if(up>=1) slLive=Math.max(slLive, entry);
          if(up>=2) slLive=Math.max(slLive, entry*1.01);
        }else{
          if(dn>=1) slLive=Math.min(slLive, entry);
          if(dn>=2) slLive=Math.min(slLive, entry*0.99);
        }
      }
      if(side==='BUY'){
        if(b.low<=slLive){ exitPrice=slLive; result = slLive===entry ? 'BE' : (slLive>entry ? 'WIN-TS' : 'LOSS'); break; }
        if(b.high>=tp){ exitPrice=tp; result='WIN'; break; }
      } else {
        if(b.high>=slLive){ exitPrice=slLive; result = slLive===entry ? 'BE' : (slLive<entry ? 'WIN-TS' : 'LOSS'); break; }
        if(b.low<=tp){ exitPrice=tp; result='WIN'; break; }
      }
    }
    if(exitPrice===null){
      exitPrice = rows[Math.min(rows.length-1, i+11)].close;
      result = 'LOSS';
    }

    const rMultiple = side==='BUY' ? ((exitPrice-entry)/risk) : ((entry-exitPrice)/risk);
    const riskMoney = equity * (Number(riskPct)/100);
    const pnl = riskMoney * rMultiple;
    equity += pnl;

    trades.push({date:rows[i].date,side,entry,sl,tp,result,r:rMultiple,pnl,equity,trigger,zone:`${price(zone.low)}-${price(zone.high)}`});
  }
  const wins = trades.filter(t=>t.result.startsWith('WIN')).length;
  const losses = trades.filter(t=>t.result==='LOSS').length;
  const be = trades.filter(t=>t.result==='BE').length;
  return {wins,losses,be,trades,total:trades.length,startCapital:Number(startCapital),endCapital:equity};
}

function renderBacktestBoard(year, trailing, startCapital, riskPct){
  const btBoard=document.getElementById('btBoard');
  const keys=Object.keys(ALL).sort();
  const blocks=[];
  for(const p of keys){
    const r=runBacktestForPair(ALL[p], year, trailing, startCapital, riskPct);
    blocks.push(`<button type='button' class='pairCard ${p===currentPair?'active':''}' data-p='${p}'><div class='p'>${p}</div><div class='s'>W:${r.wins} L:${r.losses} BE:${r.be}</div><div class='s'>End: â‚¬${r.endCapital.toFixed(0)}</div></button>`);
  }
  btBoard.innerHTML=blocks.join('');
  btBoard.querySelectorAll('.pairCard').forEach(el=>el.onclick=()=>{currentPair=el.dataset.p; pairSelect.value=currentPair; renderBacktestDetail(year,trailing,startCapital,riskPct); renderBacktestBoard(year,trailing,startCapital,riskPct); render(currentTf,strictMode)});
}

function renderBacktestDetail(year, trailing, startCapital, riskPct){
  const r=runBacktestForPair(ALL[currentPair]||[], year, trailing, startCapital, riskPct);
  document.getElementById('btDetail').innerHTML = `<div><b>${currentPair}</b> | Jaar ${year} | Trailing: ${trailing?'ON':'OFF'} | Risk ${riskPct}%</div><div style='margin-top:6px'>Wins: <b class='good'>${r.wins}</b> | Losses: <b class='bad'>${r.losses}</b> | Break-even: <b class='warn'>${r.be}</b> | Totaal: <b>${r.total}</b></div><div style='margin-top:6px'>Start: <b>â‚¬${r.startCapital.toFixed(2)}</b> â†’ Eindtotaal: <b class='good'>â‚¬${r.endCapital.toFixed(2)}</b></div>`;
  const tbody=document.querySelector('#btTable tbody');
  const detail=document.getElementById('btTradeDetail');
  tbody.innerHTML='';
  r.trades.forEach(t=>{
    const tr=document.createElement('tr');
    const cls = t.result==='LOSS' ? 'row-loss' : (t.result==='BE' ? 'row-be' : 'row-win');
    tr.className = `clickable-row ${cls}`;
    tr.innerHTML=`<td>${t.date}</td><td>${t.side}</td><td>${price(t.entry)}</td><td>${price(t.sl)}</td><td>${price(t.tp)}</td><td>${t.result}</td><td>${t.pnl.toFixed(2)}</td><td>${t.equity.toFixed(2)}</td>`;
    tr.onclick=()=>{
      detail.innerHTML = `<div><b>${currentPair}</b> | ${t.date} | ${t.side} | Resultaat: <b>${t.result}</b></div><div style='margin-top:6px'>Trigger: ${t.trigger}</div><div style='margin-top:6px'>Zone: ${t.zone} | Entry ${price(t.entry)} | SL ${price(t.sl)} | TP ${price(t.tp)}</div><div style='margin-top:6px'>PnL: <b>â‚¬${t.pnl.toFixed(2)}</b> | Equity na trade: <b>â‚¬${t.equity.toFixed(2)}</b></div>`;
    };
    tbody.appendChild(tr);
  });
}

function renderPairBoard(){
  const board=document.getElementById('pairBoard');
  const keys=Object.keys(ALL).sort();
  const html=[];
  for(const p of keys){
    const arr=ALL[p];
    if(!arr || arr.length<80) continue;
    const st=structure(arr);
    const cl=classify(arr, st.trend, st.events, st.S, false, true, arr); // strict check
    const ok=cl.strictPass && cl.pattern!=='NO TRADE (STRICT PDF)';
    const tone=ok?'#2ad08f':'#ff9fb0';
    const active = p===currentPair ? 'active' : '';
    html.push(`<button type='button' class='pairCard ${active}' data-p='${p}' style='border-color:${tone}55'><div class='p'>${p}</div><div class='s' style='color:${tone}'>${ok?'TRADE MOGELIJK':'GEEN TRADE'}</div><div class='s'>${cl.localState}</div></button>`);
  }
  board.innerHTML=html.join('');
  board.querySelectorAll('.pairCard').forEach(el=>el.addEventListener('click',()=>{
    currentPair=el.dataset.p;
    pairSelect.value=currentPair;
    renderPairBoard();
    render(currentTf,strictMode);
  }));
}

const pairSelect=document.getElementById('pairSelect');
const bD1=document.getElementById('tfD1'), bH4=document.getElementById('tfH4'), bStrict=document.getElementById('strictBtn'), bRR=document.getElementById('rrBtn');
const tabAnalysis=document.getElementById('tabAnalysis'), tabBacktest=document.getElementById('tabBacktest');
const analysisView=document.getElementById('analysisView'), backtestView=document.getElementById('backtestView');
const btYear=document.getElementById('btYear'), btTrailing=document.getElementById('btTrailing'), btRun=document.getElementById('btRun'), btStatus=document.getElementById('btStatus');
const btCapital=document.getElementById('btCapital'), btRisk=document.getElementById('btRisk');
let currentTf='D1', strictMode=false, rrMult=2;
bD1.onclick=()=>{currentTf='D1';bD1.classList.add('active');bH4.classList.remove('active');render(currentTf,strictMode)};
bH4.onclick=()=>{currentTf='H4';bH4.classList.add('active');bD1.classList.remove('active');render(currentTf,strictMode)};
bStrict.onclick=()=>{strictMode=!strictMode; bStrict.textContent=`Strict PDF mode: ${strictMode?'ON':'OFF'}`; bStrict.classList.toggle('active', strictMode); render(currentTf,strictMode)};
bRR.onclick=()=>{rrMult = rrMult===2 ? 3 : 2; bRR.textContent=`RR model: 1:${rrMult}`; bRR.classList.toggle('active', rrMult===3); render(currentTf,strictMode)};

const pairKeys=Object.keys(ALL).sort();
pairSelect.innerHTML = pairKeys.map(p=>`<option value="${p}">${p}</option>`).join('');
if(!pairKeys.includes(currentPair) && pairKeys.length) currentPair=pairKeys[0];
pairSelect.value=currentPair;
pairSelect.onchange=()=>{currentPair=pairSelect.value; renderPairBoard(); render(currentTf,strictMode); renderBacktestBoard(btYear.value, btTrailing.checked, Number(btCapital.value||10000), Number(btRisk.value||1)); renderBacktestDetail(btYear.value, btTrailing.checked, Number(btCapital.value||10000), Number(btRisk.value||1))};

tabAnalysis.onclick=()=>{tabAnalysis.classList.add('active');tabBacktest.classList.remove('active');analysisView.classList.remove('hidden');backtestView.classList.add('hidden');};
tabBacktest.onclick=()=>{tabBacktest.classList.add('active');tabAnalysis.classList.remove('active');backtestView.classList.remove('hidden');analysisView.classList.add('hidden');renderBacktestBoard(btYear.value, btTrailing.checked, Number(btCapital.value||10000), Number(btRisk.value||1));renderBacktestDetail(btYear.value, btTrailing.checked, Number(btCapital.value||10000), Number(btRisk.value||1));};

function runBacktestUI(){
  btRun.textContent='Running...';
  btStatus.textContent='';
  const y=btYear.value, tr=btTrailing.checked;
  const cap=Number(btCapital.value||10000), risk=Number(btRisk.value||1);
  setTimeout(()=>{
    renderBacktestBoard(y, tr, cap, risk);
    renderBacktestDetail(y, tr, cap, risk);
    btRun.textContent='Run backtest';
    btStatus.textContent=`Klaar: ${y} | Trailing ${tr?'ON':'OFF'} | Start â‚¬${cap} | Risk ${risk}% | ${new Date().toLocaleTimeString()}`;
  }, 0);
}

btRun.onclick=runBacktestUI;
btYear.onchange=runBacktestUI;
btTrailing.onchange=runBacktestUI;
btCapital.onchange=runBacktestUI;
btRisk.onchange=runBacktestUI;

renderPairBoard();
render('D1', false);
runBacktestUI();
</script>
</body>
</html>